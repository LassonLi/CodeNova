<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Codenova Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
      margin: 0;
      padding: 0;
    }
    /* ADDED: Styles for new elements */
    .main-title {
      text-align: center;
      color: #0d274d;
      margin-top: 20px;
      margin-bottom: 0;
      font-size: 36px;
    }
    .footer-band {
      background-color: #0d274d;
      color: #f0f0f0;
      text-align: center;
      padding: 20px 0;
      width: 100%;
      margin-top: 40px;
    }
    .footer-band p {
      margin: 0;
      font-size: 14px;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 40px;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 40px;
    }
    .logo {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }
    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: #0d274d;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }
    .card h2 {
      font-size: 20px;
      margin: 0 0 15px;
    }
    .card p {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      margin-top: auto;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th, .history-table td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .history-table th {
      font-weight: bold;
    }
    .refresh-button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background-color: #0066ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    .timestamp {
      font-size: 12px;
      color: #888;
      text-align: center;
    }
    #networth-card {
      background-color: #0d274d;
      color: white;
    }
    #networth-card h2 {
      font-size: 24px;
    }
    #networth-card p {
      font-size: 36px;
    }
    .asset-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .asset-item:last-child {
      border-bottom: none;
    }
    .asset-item span:last-child {
      font-weight: bold;
    }
    .asset-list-container {
      max-height: 130px; 
      overflow-y: auto;
      padding-right: 10px;
    }
    .asset-list-container::-webkit-scrollbar {
      width: 6px;
    }
    .asset-list-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .asset-list-container::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 10px;
    }
    .asset-list-container::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .card-action-button {
      flex-grow: 1;
      padding: 8px;
      font-size: 14px;
      font-weight: bold;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
    }
    .card-action-button:hover {
      background-color: #f0f0f0;
    }
    
    #stock-list-container {
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .stock-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .stock-info-item:hover {
      background-color: #f9f9f9;
    }
    .stock-info-item:last-child {
      border-bottom: none;
    }
    
    .stock-details {
      display: flex;
      flex-direction: column;
    }
    .stock-details .code {
      font-weight: bold;
      font-size: 16px;
    }
    .stock-details .price {
      font-size: 14px;
      color: #555;
    }
    
    .stock-change {
      font-weight: bold;
      font-size: 15px;
      padding: 4px 8px;
      border-radius: 5px;
      color: white;
    }
    .stock-change.positive {
      background-color: #28a745;
    }
    .stock-change.negative {
      background-color: #dc3545;
    }

    /* MODIFIED: Adjusted grid layout from second file */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 2fr 1.2fr;
      grid-template-rows: auto auto 1fr auto;
      gap: 30px;
    }

    #networth-card { grid-column: 1; grid-row: 1; }
    #stock-assets-card { grid-column: 1; grid-row: 2; }
    #cash-card { grid-column: 1; grid-row: 3; }
    #stock-chart-card { grid-column: 2; grid-row: 1 / 3; }
    #market-watch-card { grid-column: 3; grid-row: 1 / 3; }
    #portfolio-card { grid-column: 2 / 4; grid-row: 3; }
    #history-card { grid-column: 1 / 4; grid-row: 4; }

    #portfolio-charts-container {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      flex-grow: 1;
      gap: 20px;
    }
    /* MODIFIED: Portfolio chart wrapper style from second file */
    .portfolio-chart-wrapper {
      flex: 1;
      max-width: 48%;
      position: relative;
      min-height: 300px;
    }
    .chart-container-large {
        flex-grow: 1;
        position: relative;
        min-height: 350px;
    }
    /* MODIFIED: Combined canvas style from second file */
    .chart-container-large canvas, .portfolio-chart-wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
    }
    .amount-positive {
        color: #28a745;
        font-weight: bold;
    }
    .amount-negative {
        color: #dc3545;
        font-weight: bold;
    }
    #history-pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 20px;
    }
    .pagination-button {
        padding: 8px 16px;
        font-size: 14px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        border-radius: 5px;
        cursor: pointer;
        margin: 0 5px;
    }
    .pagination-button:hover:not(:disabled) {
        background-color: #f0f0f0;
    }
    .pagination-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    #page-info {
        margin: 0 15px;
        font-size: 14px;
        color: #555;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .modal.modal-visible {
        display: flex;
    }
    .modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    .modal-close-btn {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .modal-close-btn:hover {
        color: #000;
    }
    .modal-content h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 25px;
        color: #0d274d;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
    }
    #current-quantity-display {
        font-size: 12px;
        color: #555;
        margin-left: 10px;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }
    .quantity-control {
        position: relative;
    }
    .quantity-arrows {
        position: absolute;
        right: 1px;
        top: 1px;
        bottom: 1px;
        display: flex;
        flex-direction: column;
    }
    .quantity-arrow {
        height: 50%;
        width: 25px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        border-left: 1px solid #ddd;
        user-select: none;
    }
    .quantity-arrow:hover {
        background-color: #f0f0f0;
    }
    .quantity-arrow.up {
        border-bottom: 1px solid #eee;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 30px;
    }
    #total-amount-display {
        font-size: 18px;
        font-weight: bold;
        margin-right: 20px;
    }
    #total-amount-display span {
        color: #0d274d;
    }
    #confirm-transaction-btn {
        padding: 12px 25px;
        font-size: 16px;
        background-color: #0066ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #confirm-transaction-btn:hover {
        background-color: #0052cc;
    }
  </style>
</head>
<body>
  <h1 class="main-title">Portfolio Panel</h1>

  <div class="container">
    <div class="header">
      <img src="logo.jpg" alt="logo" class="logo" />
      <div class="logo-text">CODENOVA</div>
    </div>
    <div class="dashboard">
      <!-- Cards -->
      <div class="card" id="networth-card"><h2>Networth</h2><p>Calculating...</p></div>
      <div class="card" id="stock-assets-card"><h2>Stock</h2><div class="asset-list-container"></div><div class="card-actions"><button class="card-action-button">+ Buy</button><button class="card-action-button">- Sell</button></div></div>
      <!-- REMOVED: Bond Card was here -->
      <div class="card" id="cash-card"><h2>Cash</h2><div class="asset-list-container"><div class="asset-item"><span>USD Account</span><span>$3,800</span></div><div class="asset-item"><span>Money Market</span><span>$2,200</span></div><div class="asset-item"><span>EUR Account</span><span>$1,500</span></div><div class="asset-item"><span>GBP Account</span><span>$950</span></div><div class="asset-item"><span>CD #123</span><span>$3,000</span></div></div><div class="card-actions"><button class="card-action-button">+ Deposit</button><button class="card-action-button">- Withdraw</button></div></div>
      <div class="card" id="stock-chart-card"><h2>Stock</h2><div class="chart-container-large"><canvas id="stockChart"></canvas></div></div>
      <!-- MODIFIED: Portfolio card content from second file -->
      <div class="card" id="portfolio-card">
        <h2>Portfolio</h2>
        <div id="portfolio-charts-container">
          <div class="portfolio-chart-wrapper"><canvas id="totalAmountChart"></canvas></div>
          <div class="portfolio-chart-wrapper"><canvas id="interestRateChart"></canvas></div>
        </div>
      </div>
      <div class="card" id="market-watch-card"><h2>Market Watch</h2><div id="stock-list-container"></div><button class="refresh-button">Refresh</button><p class="timestamp">Last updated: Just now</p></div>
      <!-- MODIFIED: History table header updated -->
      <div class="card" id="history-card"><h2>History</h2><table class="history-table"><thead><tr><th>Date</th><th>Assets-name</th><th>Type</th><th>Quantity</th><th>Amount</th></tr></thead><tbody></tbody></table><div id="history-pagination"><button id="prev-page-btn" class="pagination-button">Previous</button><span id="page-info"></span><button id="next-page-btn" class="pagination-button">Next</button></div></div>
    </div>
  </div>

  <div id="transaction-modal" class="modal">
    <div class="modal-content">
      <span id="modal-close-btn" class="modal-close-btn">&times;</span>
      <h2 id="modal-title">Transaction</h2>
      <div class="form-group"><label for="asset-select" id="asset-select-label">Asset Name</label><select id="asset-select"></select></div>
      <div class="form-group">
        <label for="quantity-input" id="quantity-input-label">Quantity</label><span id="current-quantity-display" style="display: none;"></span>
        <div class="quantity-control"><input type="number" id="quantity-input" value="1" min="1"><div class="quantity-arrows"><div class="quantity-arrow up" id="quantity-up-arrow">▲</div><div class="quantity-arrow down" id="quantity-down-arrow">▼</div></div></div>
      </div>
      <div class="form-group"><label for="price-per-unit">Price per Unit</label><p id="price-per-unit">$0.00</p></div>
      <div class="modal-footer"><div id="total-amount-display">Total: <span>$0.00</span></div><button id="confirm-transaction-btn">Confirm</button></div>
    </div>
  </div>

  <script>
    // ===== Data and Rendering Functions =====

    let assetPriceMap = new Map();
    let ownedStockAssets = []; 
    let stockChartInstance = null;
    // ADDED: Chart instances from second file
    let totalAmountChartInstance = null;
    let interestRateChartInstance = null;
    let historyData = [];
    let currentPage = 1;
    const itemsPerPage = 5;

    // ===== NEW FUNCTION: Calculate and Display Net Worth =====
    async function fetchAndCalculateNetWorth() {
        const networthElement = document.querySelector('#networth-card p');
        if (!networthElement) return;
        networthElement.textContent = 'Calculating...';

        const stockApiUrl = 'http://localhost:3000/assets/type/stock';
        const cashApiUrl = 'http://localhost:3000/assets/type/cash';

        try {
            // Fetch both APIs at the same time
            const [stockResponse, cashResponse] = await Promise.all([
                fetch(stockApiUrl),
                fetch(cashApiUrl)
            ]);

            if (!stockResponse.ok || !cashResponse.ok) {
                throw new Error('Failed to fetch asset data for net worth calculation');
            }

            const stockData = await stockResponse.json();
            const cashData = await cashResponse.json();

            // Helper function to get the sum of the most recent version of each asset
            const getLatestTotalAmount = (data) => {
                const latestAssets = new Map();
                data.forEach(asset => {
                    const existing = latestAssets.get(asset.asset_name);
                    // If asset is not in map, or the current one is newer, update it
                    if (!existing || new Date(asset.updated_at) > new Date(existing.updated_at)) {
                        latestAssets.set(asset.asset_name, asset);
                    }
                });

                // Sum the total_amount from the latest assets
                let total = 0;
                for (const asset of latestAssets.values()) {
                    total += parseFloat(asset.total_amount) || 0;
                }
                return total;
            };

            const stockAmount = getLatestTotalAmount(stockData);
            const cashAmount = getLatestTotalAmount(cashData);
            const netWorth = stockAmount + cashAmount;

            // Update the UI with the formatted total
            networthElement.textContent = netWorth.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD'
            });

        } catch (error) {
            console.error("Error calculating net worth:", error);
            networthElement.textContent = 'Error';
        }
    }


    function renderStockAssets(assetsData) {
        const container = document.querySelector('#stock-assets-card .asset-list-container');
        if (!container) return;
        container.innerHTML = ''; 
        if (!assetsData || assetsData.length === 0) {
            container.innerHTML = '<p>No stock assets found.</p>';
            return;
        }
        assetsData.forEach(asset => {
            const totalAmount = parseFloat(asset.total_amount);
            const formattedAmount = totalAmount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            container.innerHTML += `<div class="asset-item"><span>${asset.asset_name}</span><span>${formattedAmount}</span></div>`;
        });
    }

    async function fetchStockAssets() {
        const container = document.querySelector('#stock-assets-card .asset-list-container');
        const apiUrl = 'http://localhost:3000/assets/type/stock';
        if (container) container.innerHTML = '<p>Loading assets...</p>';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            ownedStockAssets = data.map(asset => asset.asset_name); 
            renderStockAssets(data);
        } catch (error) {
            console.error("Error fetching stock assets:", error);
            if (container) container.innerHTML = `<p style="color: red;">Failed to load stock assets.</p>`;
        }
    }

    async function fetchAndDrawStockHistory(ticker) {
        if (!stockChartInstance || !ticker) return;
        const stockChartCardTitle = document.querySelector('#stock-chart-card h2');
        if (stockChartCardTitle) stockChartCardTitle.textContent = `Stock: ${ticker} (Loading...)`;
        try {
            const response = await fetch(`http://localhost:3000/stockapi/history/${ticker}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const historyData = await response.json();
            const sampleData = historyData.length > 100 ? historyData.filter((_, i) => i % Math.floor(historyData.length / 100) === 0) : historyData;
            const labels = sampleData.map(item => new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }));
            const dataPoints = sampleData.map(item => item.close);
            stockChartInstance.data.labels = labels;
            stockChartInstance.data.datasets[0].data = dataPoints;
            stockChartInstance.data.datasets[0].label = `${ticker} Stock Value`;
            stockChartInstance.update();
            if (stockChartCardTitle) stockChartCardTitle.textContent = `Stock: ${ticker}`;
        } catch (error) {
            console.error(`Error fetching history for ${ticker}:`, error);
            if (stockChartCardTitle) stockChartCardTitle.textContent = `Stock: ${ticker} (Error loading chart)`;
        }
    }

    async function fetchMarketData() {
        const container = document.getElementById('stock-list-container');
        if (container) container.innerHTML = '<p>Loading market data...</p>';
        try {
            const response = await fetch('http://localhost:3000/stockapi/price/');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            const formattedData = data.map(stock => ({ code: stock.symbol, price: stock.price, changePercent: stock.percentChange }));
            const newPriceMap = new Map();
            formattedData.forEach(stock => newPriceMap.set(stock.code, stock.price));
            if (formattedData.length > 0) {
                renderStockList(formattedData);
                assetPriceMap = new Map([...assetPriceMap, ...newPriceMap]);
                if (!stockChartInstance.data.datasets[0].label || stockChartInstance.data.datasets[0].label === 'Stock Value') {
                    fetchAndDrawStockHistory(formattedData[0].code);
                }
            } else {
                if (container) container.innerHTML = '<p style="color: red;">Could not load any market data.</p>';
            }
            updateTimestamp();
        } catch (error) {
            console.error("Error fetching market data:", error);
            if (container) container.innerHTML = `<p style="color: red;">Could not load market data.</p>`;
        }
    }

    function updateTimestamp() {
        const timestampEl = document.querySelector('#market-watch-card .timestamp');
        if (timestampEl) timestampEl.textContent = `Last updated at: ${new Date().toLocaleTimeString()}`;
    }

    function renderStockList(data) {
      const container = document.getElementById('stock-list-container');
      if (!container) return;
      container.innerHTML = '';
      data.forEach(stock => {
        const changeClass = stock.changePercent >= 0 ? 'positive' : 'negative';
        const changeSign = stock.changePercent >= 0 ? '+' : '';
        container.innerHTML += `
          <div class="stock-info-item">
            <div class="stock-details">
              <span class="code">${stock.code}</span>
              <span class="price">$${stock.price.toFixed(2)}</span>
            </div>
            <div class="stock-change ${changeClass}">${changeSign}${stock.changePercent.toFixed(2)}%</div>
          </div>`;
      });
    }

    // ADDED: Portfolio charts function from second file
    async function fetchAndDrawPortfolioCharts() {
        const apiUrl = 'http://localhost:3000/assets/type/stock';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const rawData = await response.json();

            const latestAssets = new Map();
            rawData.forEach(asset => {
                const existing = latestAssets.get(asset.asset_name);
                if (!existing || new Date(asset.updated_at) > new Date(existing.updated_at)) {
                    latestAssets.set(asset.asset_name, asset);
                }
            });
            const portfolioData = Array.from(latestAssets.values());

            const labels = portfolioData.map(asset => asset.asset_name);
            const totalAmounts = portfolioData.map(asset => parseFloat(asset.total_amount));
            const interestRates = portfolioData.map(asset => parseFloat(asset.interest_rate));

            const ctxTotalAmount = document.getElementById('totalAmountChart');
            if (ctxTotalAmount) {
                if (totalAmountChartInstance) totalAmountChartInstance.destroy();
                totalAmountChartInstance = new Chart(ctxTotalAmount, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Amount ($)',
                            data: totalAmounts,
                            backgroundColor: 'rgba(0, 71, 171, 0.7)',
                            borderColor: 'rgba(0, 71, 171, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Stock Portfolio by Total Amount' },
                            tooltip: { callbacks: { label: ctx => `$${ctx.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` } }
                        },
                        scales: { y: { beginAtZero: true, ticks: { callback: val => '$' + (val / 1000) + 'k' } } }
                    }
                });
            }

            const ctxInterestRate = document.getElementById('interestRateChart');
            if (ctxInterestRate) {
                 if (interestRateChartInstance) interestRateChartInstance.destroy();
                interestRateChartInstance = new Chart(ctxInterestRate, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Interest Rate',
                            data: interestRates,
                            backgroundColor: interestRates.map(rate => rate >= 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
                            borderColor: interestRates.map(rate => rate >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Stock Portfolio by Interest Rate' },
                            tooltip: { callbacks: { label: ctx => `${(ctx.parsed.y * 100).toFixed(2)}%` } }
                        },
                        scales: { y: { ticks: { callback: val => (val * 100).toFixed(0) + '%' } } }
                    }
                });
            }
        } catch (error) {
            console.error("Error fetching or drawing portfolio charts:", error);
            const container = document.getElementById('portfolio-charts-container');
            if (container) container.innerHTML = `<p style="color: red; text-align: center; width: 100%;">Failed to load portfolio charts.</p>`;
        }
    }

    // --- History Data & Pagination ---
    function displayHistoryPage() {
        const historyTableBody = document.querySelector('#history-card tbody');
        const pageInfoSpan = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-page-btn');
        const nextButton = document.getElementById('next-page-btn');
        historyTableBody.innerHTML = '';

        if (!historyData || historyData.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">No transaction history found.</td></tr>`;
            pageInfoSpan.textContent = 'Page 0 of 0';
            prevButton.disabled = true;
            nextButton.disabled = true;
            return;
        }

        const totalPages = Math.ceil(historyData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedItems = historyData.slice(startIndex, startIndex + itemsPerPage);

        paginatedItems.forEach(item => {
            // Use 'Operation' (capital 'O') from the new API response
            const operation = item.Operation.toLowerCase();
            const isNegative = ['sell', 'withdraw'].includes(operation);
            const amountSign = isNegative ? '-' : '+';
            const amountClass = isNegative ? 'amount-negative' : 'amount-positive';

            // Use 'Amount' (capital 'A')
            const totalAmount = parseFloat(item.Amount);
            const formattedAmount = `${amountSign}$${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // Use 'Quantity' (capital 'Q') and format it to 2 decimal places for better readability
            const formattedQuantity = parseFloat(item.Quantity).toFixed(2);

            // Construct the row using the correct field names from the API response
            const row = `<tr>
                <td>${new Date(item.Date).toLocaleString()}</td>
                <td>${item['Asset name']}</td>
                <td>${item.Type}</td>
                <td>${formattedQuantity}</td>
                <td class="${amountClass}">${formattedAmount}</td>
            </tr>`;
            historyTableBody.innerHTML += row;
        });

        pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages;
    }
    // ===== MODIFICATION END =====

    async function fetchHistoryData() {
        const historyTableBody = document.querySelector('#history-card tbody');
        try {
            const response = await fetch('http://localhost:3000/transactions');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            historyData = await response.json();
            currentPage = 1;
            displayHistoryPage();
        } catch (error) {
            console.error("Error fetching transaction history:", error);
            historyTableBody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Failed to load transaction history.</td></tr>`;
        }
    }

    // ===== Main Execution on Page Load =====
    document.addEventListener('DOMContentLoaded', () => {
        const ctx2 = document.getElementById('stockChart');
        if (ctx2) {
            stockChartInstance = new Chart(ctx2, {
                type: 'line', data: { labels: [], datasets: [{ label: 'Stock Value', data: [], fill: true, backgroundColor: 'rgba(77, 166, 255, 0.1)', borderColor: '#0066ff', tension: 0.3 }] },
                options: { scales: { y: { beginAtZero: false } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
            });
        }
        
        // --- Call all data fetching functions ---
        fetchAndCalculateNetWorth(); // ADDED: Calculate net worth on load
        fetchStockAssets();
        fetchMarketData();
        fetchHistoryData();
        // ADDED: Call to render new portfolio charts
        fetchAndDrawPortfolioCharts();

        // --- Event Listeners ---
        const prevButton = document.getElementById('prev-page-btn');
        const nextButton = document.getElementById('next-page-btn');
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; displayHistoryPage(); } });
        nextButton.addEventListener('click', () => { if (currentPage < Math.ceil(historyData.length / itemsPerPage)) { currentPage++; displayHistoryPage(); } });

        document.querySelector('#market-watch-card .refresh-button').addEventListener('click', fetchMarketData);
        document.getElementById('stock-list-container').addEventListener('click', (event) => {
            const stockItem = event.target.closest('.stock-info-item');
            if (stockItem) {
                const ticker = stockItem.querySelector('.stock-details .code').textContent;
                if (ticker) fetchAndDrawStockHistory(ticker);
            }
        });

        // --- Modal Logic (Kept from original, more functional file) ---
        const modal = document.getElementById('transaction-modal');
        const closeModalBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const assetSelect = document.getElementById('asset-select');
        const quantityInput = document.getElementById('quantity-input');
        const priceDisplay = document.getElementById('price-per-unit');
        const totalDisplay = document.querySelector('#total-amount-display span');
        const confirmBtn = document.getElementById('confirm-transaction-btn');
        const quantityDisplay = document.getElementById('current-quantity-display');
        
        const calculateTotal = () => {
            const selectedAssetName = assetSelect.value;
            const price = assetPriceMap.get(selectedAssetName) || 0;
            const quantity = parseFloat(quantityInput.value) || 0;
            const total = price * quantity;
            totalDisplay.textContent = `$${total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        const fetchAndUpdatePrice = async () => {
            const selectedAssetName = assetSelect.value;
            const isSellAction = modalTitle.textContent.includes('Sell');

            quantityDisplay.style.display = 'none';
            quantityInput.removeAttribute('max');

            if (!selectedAssetName) {
                priceDisplay.textContent = '$0.00';
                calculateTotal();
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/assets/${selectedAssetName}`);
                if (!response.ok) throw new Error('Failed to fetch asset details');
                
                const assetDetails = await response.json();
                const price = parseFloat(assetDetails.current_price_per_unit);
                
                assetPriceMap.set(selectedAssetName, price);
                priceDisplay.textContent = `$${price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                if (isSellAction) {
                    const currentQuantity = parseFloat(assetDetails.current_quantity);
                    quantityDisplay.textContent = `Holding: ${currentQuantity}`;
                    quantityDisplay.style.display = 'inline';
                    quantityInput.setAttribute('max', currentQuantity);
                }

            } catch (error) {
                console.error(`Failed to fetch price for ${selectedAssetName}:`, error);
                assetPriceMap.set(selectedAssetName, 0);
                priceDisplay.textContent = '$0.00';
            }
            calculateTotal();
        };

        const openModal = (action, assetType) => {
            modalTitle.textContent = `${action} ${assetType}`;
            assetSelect.innerHTML = '';
            let assetList = [];

            if (assetType === 'Stock') {
                if (action === 'Sell') {
                    assetList = ownedStockAssets;
                } else { // For 'Buy', use the list from market watch
                    assetList = Array.from(assetPriceMap.keys());
                }
            }

            if (assetList.length === 0 && assetType === 'Stock' && action === 'Sell') {
                alert("You do not own any stocks to sell.");
                return;
            }

            assetList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                assetSelect.appendChild(option);
            });
            
            quantityInput.value = 1;
            modal.classList.add('modal-visible');
            fetchAndUpdatePrice();
        };

        const closeModal = () => modal.classList.remove('modal-visible');
        
        async function handleTransaction() {
            const fullActionText = modalTitle.textContent;
            const transaction_type = fullActionText.split(' ')[0].toLowerCase();
            const asset_name = assetSelect.value;
            const quantity = parseFloat(quantityInput.value);
            const price_per_unit = assetPriceMap.get(asset_name) || 0;
            
            if (!asset_name || !quantity || quantity <= 0) {
                alert("Invalid transaction details.");
                return;
            }
             if (price_per_unit <= 0) {
                alert("Could not determine the price for this asset. Please try again.");
                return;
            }

            const body = {
                asset_type: "stock",
                transaction_type: transaction_type,
                quantity: quantity,
                price_per_unit: price_per_unit,
                transaction_amount: quantity * price_per_unit
            };

            try {
                const response = await fetch(`http://localhost:3000/assets/${asset_name}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                await response.json();
                alert(`Success! Transaction completed.`);
                closeModal();
                // Refresh all relevant data on success
                fetchAndCalculateNetWorth(); // ADDED: Recalculate net worth after transaction
                fetchStockAssets();
                fetchHistoryData();
                fetchAndDrawPortfolioCharts();

            } catch (error) {
                console.error('Transaction failed:', error);
                alert(`Transaction failed: ${error.message}`);
            }
        }

        document.querySelectorAll('.card-action-button').forEach(button => {
            button.addEventListener('click', () => {
                const actionText = button.textContent;
                const card = button.closest('.card');
                let action, assetType;
                if (actionText.includes('Buy')) action = 'Buy';
                if (actionText.includes('Sell')) action = 'Sell';
                if (card.id.includes('stock')) assetType = 'Stock';
                if (card.id.includes('cash')) assetType = 'Cash';
                if(action && assetType === 'Stock') openModal(action, assetType);
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        
        assetSelect.addEventListener('change', fetchAndUpdatePrice);

        quantityInput.addEventListener('input', () => {
            const max = parseFloat(quantityInput.max);
            if (!isNaN(max) && parseFloat(quantityInput.value) > max) {
                quantityInput.value = max;
            }
            calculateTotal();
        });

        document.getElementById('quantity-up-arrow').addEventListener('click', () => { quantityInput.stepUp(); calculateTotal(); });
        document.getElementById('quantity-down-arrow').addEventListener('click', () => { quantityInput.stepDown(); calculateTotal(); });
        
        confirmBtn.addEventListener('click', handleTransaction);
    });
  </script>

  <footer class="footer-band">
    <p>&copy; 2025 Codenova Financial Dashboard. All Rights Reserved.</p>
  </footer>
</body>
</html>