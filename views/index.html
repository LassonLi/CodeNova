<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Codenova Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 40px;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 40px;
    }
    .logo {
      width: 50px;
      height: 50px;
      margin-right: 15px;
    }
    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: #0d274d;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
    }
    .card h2 {
      font-size: 20px;
      margin: 0 0 15px;
    }
    .card p {
      font-size: 24px;
      font-weight: bold;
      margin: 0;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      margin-top: auto;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th, .history-table td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .history-table th {
      font-weight: bold;
    }
    .refresh-button {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      background-color: #0066ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    .timestamp {
      font-size: 12px;
      color: #888;
      text-align: center;
    }
    #networth-card {
      background-color: #0d274d;
      color: white;
    }
    #networth-card h2 {
      font-size: 24px;
    }
    #networth-card p {
      font-size: 36px;
    }
    .asset-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .asset-item:last-child {
      border-bottom: none;
    }
    .asset-item span:last-child {
      font-weight: bold;
    }
    .asset-list-container {
      max-height: 130px; 
      overflow-y: auto;
      padding-right: 10px;
    }
    .asset-list-container::-webkit-scrollbar {
      width: 6px;
    }
    .asset-list-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    .asset-list-container::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 10px;
    }
    .asset-list-container::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .card-action-button {
      flex-grow: 1;
      padding: 8px;
      font-size: 14px;
      font-weight: bold;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s;
    }
    .card-action-button:hover {
      background-color: #f0f0f0;
    }
    
    #stock-list-container {
      flex-grow: 1;
      overflow-y: auto;
    }
    
    .stock-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .stock-info-item:hover {
      background-color: #f9f9f9;
    }
    .stock-info-item:last-child {
      border-bottom: none;
    }
    
    .stock-details {
      display: flex;
      flex-direction: column;
    }
    .stock-details .code {
      font-weight: bold;
      font-size: 16px;
    }
    .stock-details .price {
      font-size: 14px;
      color: #555;
    }
    
    .stock-change {
      font-weight: bold;
      font-size: 15px;
      padding: 4px 8px;
      border-radius: 5px;
      color: white;
    }
    .stock-change.positive {
      background-color: #28a745;
    }
    .stock-change.negative {
      background-color: #dc3545;
    }

    /* MODIFIED: Adjusted grid layout */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 2fr 1.2fr;
      grid-template-rows: auto auto 1fr auto; /* Adjusted for new layout */
      gap: 30px;
    }

    #networth-card { grid-column: 1; grid-row: 1; }
    #stock-assets-card { grid-column: 1; grid-row: 2; }
    /* #bond-card was here */
    #cash-card { grid-column: 1; grid-row: 3; } /* Moved up */
    #stock-chart-card { grid-column: 2; grid-row: 1 / 3; }
    #market-watch-card { grid-column: 3; grid-row: 1 / 3; }
    #portfolio-card { grid-column: 2 / 4; grid-row: 3; } /* Adjusted row span */
    #history-card { grid-column: 1 / 4; grid-row: 4; } /* Moved up */

    #portfolio-charts-container {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      flex-grow: 1;
      gap: 20px;
    }
    .portfolio-chart-wrapper {
      flex: 1;
      max-width: 48%; /* Adjusted for better spacing */
      position: relative;
      min-height: 300px; /* Ensure wrapper has height */
    }
    .chart-container-large {
        flex-grow: 1;
        position: relative;
        min-height: 350px;
    }
    .chart-container-large canvas, .portfolio-chart-wrapper canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
    }
    .amount-positive {
        color: #28a745;
        font-weight: bold;
    }
    .amount-negative {
        color: #dc3545;
        font-weight: bold;
    }
    #history-pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 20px;
    }
    .pagination-button {
        padding: 8px 16px;
        font-size: 14px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        border-radius: 5px;
        cursor: pointer;
        margin: 0 5px;
    }
    .pagination-button:hover:not(:disabled) {
        background-color: #f0f0f0;
    }
    .pagination-button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    #page-info {
        margin: 0 15px;
        font-size: 14px;
        color: #555;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    .modal.modal-visible {
        display: flex;
    }
    .modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
        position: relative;
    }
    .modal-close-btn {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .modal-close-btn:hover {
        color: #000;
    }
    .modal-content h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 25px;
        color: #0d274d;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
    }
    .quantity-control {
        position: relative;
    }
    .quantity-arrows {
        position: absolute;
        right: 1px;
        top: 1px;
        bottom: 1px;
        display: flex;
        flex-direction: column;
    }
    .quantity-arrow {
        height: 50%;
        width: 25px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        border-left: 1px solid #ddd;
        user-select: none;
    }
    .quantity-arrow:hover {
        background-color: #f0f0f0;
    }
    .quantity-arrow.up {
        border-bottom: 1px solid #eee;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-top: 30px;
    }
    #total-amount-display {
        font-size: 18px;
        font-weight: bold;
        margin-right: 20px;
    }
    #total-amount-display span {
        color: #0d274d;
    }
    #confirm-transaction-btn {
        padding: 12px 25px;
        font-size: 16px;
        background-color: #0066ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    #confirm-transaction-btn:hover {
        background-color: #0052cc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Rocket_icon.svg/2048px-Rocket_icon.svg.png" alt="logo" class="logo" />
      <div class="logo-text">CODENOVA</div>
    </div>
    <div class="dashboard">
      <!-- Cards -->
      <div class="card" id="networth-card"><h2>Networth</h2><p>$37,150</p></div>
      <div class="card" id="stock-assets-card"><h2>Stock</h2><div class="asset-list-container"><div class="asset-item"><span>AAPL</span><span>$4,450</span></div><div class="asset-item"><span>TSLA</span><span>$3,200</span></div><div class="asset-item"><span>GOOGL</span><span>$2,800</span></div><div class="asset-item"><span>MSFT</span><span>$2,150</span></div><div class="asset-item"><span>AMZN</span><span>$1,900</span></div></div><div class="card-actions"><button class="card-action-button">+ Buy</button><button class="card-action-button">- Sell</button></div></div>
      <!-- REMOVED: Bond Card -->
      <div class="card" id="cash-card"><h2>Cash</h2><div class="asset-list-container"><div class="asset-item"><span>USD Account</span><span>$3,800</span></div><div class="asset-item"><span>Money Market</span><span>$2,200</span></div><div class="asset-item"><span>EUR Account</span><span>$1,500</span></div><div class="asset-item"><span>GBP Account</span><span>$950</span></div><div class="asset-item"><span>CD #123</span><span>$3,000</span></div></div><div class="card-actions"><button class="card-action-button">+ Deposit</button><button class="card-action-button">- Withdraw</button></div></div>
      <div class="card" id="stock-chart-card"><h2>Stock</h2><div class="chart-container-large"><canvas id="stockChart"></canvas></div></div>
      <div class="card" id="portfolio-card">
        <h2>Portfolio</h2>
        <div id="portfolio-charts-container">
          <div class="portfolio-chart-wrapper"><canvas id="totalAmountChart"></canvas></div>
          <div class="portfolio-chart-wrapper"><canvas id="interestRateChart"></canvas></div>
        </div>
      </div>
      <div class="card" id="market-watch-card"><h2>Market Watch</h2><div id="stock-list-container"></div><button class="refresh-button">Refresh</button><p class="timestamp">Last updated: Just now</p></div>
      <div class="card" id="history-card"><h2>History</h2><table class="history-table"><thead><tr><th>Date</th><th>Assets-name</th><th>Type</th><th>Quantity</th><th>Amount</th></tr></thead><tbody></tbody></table><div id="history-pagination"><button id="prev-page-btn" class="pagination-button">Previous</button><span id="page-info"></span><button id="next-page-btn" class="pagination-button">Next</button></div></div>
    </div>
  </div>

  <div id="transaction-modal" class="modal">
    <div class="modal-content">
      <span id="modal-close-btn" class="modal-close-btn">&times;</span>
      <h2 id="modal-title">Transaction</h2>
      <div class="form-group"><label for="asset-select" id="asset-select-label">Asset Name</label><select id="asset-select"></select></div>
      <div class="form-group"><label for="quantity-input" id="quantity-input-label">Quantity</label><div class="quantity-control"><input type="number" id="quantity-input" value="1" min="1"><div class="quantity-arrows"><div class="quantity-arrow up" id="quantity-up-arrow">▲</div><div class="quantity-arrow down" id="quantity-down-arrow">▼</div></div></div></div>
      <div class="form-group"><label for="price-per-unit">Price per Unit</label><p id="price-per-unit">$0.00</p></div>
      <div class="modal-footer"><div id="total-amount-display">Total: <span>$0.00</span></div><button id="confirm-transaction-btn">Confirm</button></div>
    </div>
  </div>

  <script>
    // ===== Data and Rendering Functions =====

    let assetPriceMap = new Map();
    let latestStockTickers = [];
    let stockChartInstance = null; 
    let totalAmountChartInstance = null;
    let interestRateChartInstance = null;

    /**
     * Fetches historical data for a given stock ticker and updates the main stock chart.
     * @param {string} ticker The stock symbol to fetch history for.
     */
    async function fetchAndDrawStockHistory(ticker) {
        if (!stockChartInstance || !ticker) {
            console.error("Chart instance or ticker not available.");
            return;
        }

        const stockChartCardTitle = document.querySelector('#stock-chart-card h2');
        if (stockChartCardTitle) {
            stockChartCardTitle.textContent = `Stock: ${ticker} (Loading...)`;
        }

        const historyApiUrl = `http://localhost:3000/stockapi/history/${ticker}`;

        try {
            const response = await fetch(historyApiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const historyData = await response.json();

            const sampleData = historyData.length > 100 ? historyData.filter((_, i) => i % Math.floor(historyData.length / 100) === 0) : historyData;

            const labels = sampleData.map(item =>
                new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })
            );
            const dataPoints = sampleData.map(item => item.close);

            stockChartInstance.data.labels = labels;
            stockChartInstance.data.datasets[0].data = dataPoints;
            stockChartInstance.data.datasets[0].label = `${ticker} Stock Value`;
            stockChartInstance.update();

            if (stockChartCardTitle) {
                stockChartCardTitle.textContent = `Stock: ${ticker}`;
            }

        } catch (error) {
            console.error(`Error fetching history for ${ticker}:`, error);
            if (stockChartCardTitle) {
                stockChartCardTitle.textContent = `Stock: ${ticker} (Error loading chart)`;
            }
            stockChartInstance.data.labels = [];
            stockChartInstance.data.datasets[0].data = [];
            stockChartInstance.update();
        }
    }


    /**
     * Fetches market data from the local API.
     */
    async function fetchMarketData() {
        const container = document.getElementById('stock-list-container');
        if (container) container.innerHTML = '<p>Loading market data...</p>';

        const apiUrl = 'http://localhost:3000/stockapi/price/';

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            
            const formattedData = data.map(stock => ({
                code: stock.symbol,
                price: stock.price,
                changePercent: stock.percentChange 
            }));

            const newPriceMap = new Map();
            formattedData.forEach(stock => newPriceMap.set(stock.code, stock.price));

            if (formattedData.length > 0) {
                renderStockList(formattedData);
                latestStockTickers = formattedData.map(stock => stock.code);
                assetPriceMap = new Map([...assetPriceMap, ...newPriceMap]);

                const firstTicker = formattedData[0].code;
                fetchAndDrawStockHistory(firstTicker);

            } else {
                if (container) container.innerHTML = '<p style="color: red;">未能加载任何市场数据，请稍后重试。</p>';
            }
            updateTimestamp();

        } catch (error) {
            console.error("获取市场数据时发生错误:", error);
            if (container) {
                container.innerHTML = `<p style="color: red;">无法加载市场数据。请确保您的本地API服务正在运行。</p>`;
            }
        }
    }

    /**
     * Updates the timestamp in the Market Watch card.
     */
    function updateTimestamp() {
        const timestampEl = document.querySelector('#market-watch-card .timestamp');
        if (timestampEl) {
            const now = new Date();
            timestampEl.textContent = `Last updated at: ${now.toLocaleTimeString()}`;
        }
    }

    // --- Market Watch Render ---
    function renderStockList(data) {
      const container = document.getElementById('stock-list-container');
      if (!container) return;
      container.innerHTML = '';
      data.forEach(stock => {
        const changeClass = stock.changePercent >= 0 ? 'positive' : 'negative';
        const changeSign = stock.changePercent >= 0 ? '+' : '';
        const itemHTML = `
          <div class="stock-info-item">
            <div class="stock-details">
              <span class="code">${stock.code}</span>
              <span class="price">$${stock.price.toFixed(2)}</span>
            </div>
            <div class="stock-change ${changeClass}">
              ${changeSign}${stock.changePercent.toFixed(2)}%
            </div>
          </div>
        `;
        container.innerHTML += itemHTML;
      });
    }

    // --- History Data & Pagination ---
    const mockHistoryData = [
        { date: '2024-02-05 09:15:00', name: 'JPM', type: 'Stock', quantity: 10, amount: 1950 },
        { date: '2024-02-02 15:00:10', name: 'GBP Account', type: 'Cash', quantity: '-', amount: 1000 },
        { date: '2024-02-01 10:30:15', name: 'AAPL', type: 'Stock', quantity: 17, amount: 3000 },
        { date: '2024-01-28 14:05:50', name: 'US Treasury', type: 'Bond', quantity: 2, amount: 2000 },
        { date: '2024-01-25 16:01:11', name: 'TSLA', type: 'Stock', quantity: 8, amount: -1500 },
        { date: '2024-01-22 11:45:30', name: 'EUR Account', type: 'Cash', quantity: '-', amount: -500 },
        { date: '2024-01-20 09:30:00', name: 'GOOGL', type: 'Stock', quantity: 15, amount: 2000 },
        { date: '2024-01-15 12:00:18', name: 'Corp Bond A', type: 'Bond', quantity: 5, amount: -2500 },
        { date: '2024-01-10 13:10:05', name: 'NVDA', type: 'Stock', quantity: 3, amount: 1200 },
        { date: '2024-01-05 15:25:45', name: 'MSFT', type: 'Stock', quantity: 2, amount: -800 },
        { date: '2023-12-28 10:05:00', name: 'AMZN', type: 'Stock', quantity: 10, amount: 2500 },
        { date: '2023-12-22 09:00:00', name: 'USD Account', type: 'Cash', quantity: '-', amount: 5000 },
        { date: '2023-12-18 11:15:21', name: 'High-Yield D', type: 'Bond', quantity: 12, amount: 1200 },
        { date: '2023-12-15 14:20:00', name: 'Money Market', type: 'Cash', quantity: '-', amount: 2200 },
        { date: '2023-12-12 10:00:00', name: 'V', type: 'Stock', quantity: 5, amount: -1375 },
    ];
    let currentPage = 1;
    const itemsPerPage = 5;
    const prevButton = document.getElementById('prev-page-btn');
    const nextButton = document.getElementById('next-page-btn');
    const pageInfoSpan = document.getElementById('page-info');
    const historyTableBody = document.querySelector('#history-card tbody');

    function displayPage() {
        historyTableBody.innerHTML = '';
        const totalPages = Math.ceil(mockHistoryData.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const paginatedItems = mockHistoryData.slice(startIndex, startIndex + itemsPerPage);
        
        paginatedItems.forEach(item => {
            const amountSign = item.amount >= 0 ? '+' : '-';
            const amountClass = item.amount >= 0 ? 'amount-positive' : 'amount-negative';
            const formattedAmount = `${amountSign}$${Math.abs(item.amount).toLocaleString()}`;
            const row = `<tr><td>${item.date}</td><td>${item.name}</td><td>${item.type}</td><td>${item.quantity}</td><td class="${amountClass}">${formattedAmount}</td></tr>`;
            historyTableBody.innerHTML += row;
        });

        pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages;
    }
    
    async function fetchAndDrawPortfolioCharts() {
        const apiUrl = 'http://localhost:3000/assets/type/stock';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const rawData = await response.json();

            const latestAssets = new Map();
            rawData.forEach(asset => {
                const existing = latestAssets.get(asset.asset_name);
                if (!existing || new Date(asset.updated_at) > new Date(existing.updated_at)) {
                    latestAssets.set(asset.asset_name, asset);
                }
            });
            const portfolioData = Array.from(latestAssets.values());

            const labels = portfolioData.map(asset => asset.asset_name);
            const totalAmounts = portfolioData.map(asset => parseFloat(asset.total_amount));
            const interestRates = portfolioData.map(asset => parseFloat(asset.interest_rate));

            const ctxTotalAmount = document.getElementById('totalAmountChart');
            if (ctxTotalAmount) {
                if (totalAmountChartInstance) {
                    totalAmountChartInstance.destroy();
                }
                totalAmountChartInstance = new Chart(ctxTotalAmount, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Amount ($)',
                            data: totalAmounts,
                            backgroundColor: 'rgba(0, 71, 171, 0.7)',
                            borderColor: 'rgba(0, 71, 171, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Stock Portfolio by Total Amount' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += '$' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value / 1000) + 'k';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            const ctxInterestRate = document.getElementById('interestRateChart');
            if (ctxInterestRate) {
                 if (interestRateChartInstance) {
                    interestRateChartInstance.destroy();
                }
                interestRateChartInstance = new Chart(ctxInterestRate, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Interest Rate',
                            data: interestRates,
                            backgroundColor: interestRates.map(rate => rate >= 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
                            borderColor: interestRates.map(rate => rate >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Stock Portfolio by Interest Rate' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += (context.parsed.y * 100).toFixed(2) + '%';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return (value * 100).toFixed(0) + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }

        } catch (error) {
            console.error("Error fetching or drawing portfolio charts:", error);
            const container = document.getElementById('portfolio-charts-container');
            if (container) {
                container.innerHTML = `<p style="color: red; text-align: center; width: 100%;">无法加载投资组合图表数据。</p>`;
            }
        }
    }

    // ===== Main Execution on Page Load =====
    document.addEventListener('DOMContentLoaded', () => {
        // --- Initial Page Renders ---
        
        const ctx2 = document.getElementById('stockChart');
        if (ctx2) {
            stockChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Stock Value',
                        data: [],
                        fill: true,
                        backgroundColor: 'rgba(77, 166, 255, 0.1)',
                        borderColor: '#0066ff',
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        y: { 
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        fetchMarketData();
        fetchAndDrawPortfolioCharts();
        displayPage();

        // --- Event Listeners ---
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; displayPage(); } });
        nextButton.addEventListener('click', () => { if (currentPage < Math.ceil(mockHistoryData.length / itemsPerPage)) { currentPage++; displayPage(); } });
        
        const refreshButton = document.querySelector('#market-watch-card .refresh-button');
        if (refreshButton) {
            refreshButton.addEventListener('click', fetchMarketData);
        }

        const marketWatchContainer = document.getElementById('stock-list-container');
        if (marketWatchContainer) {
            marketWatchContainer.addEventListener('click', (event) => {
                const stockItem = event.target.closest('.stock-info-item');
                if (stockItem) {
                    const ticker = stockItem.querySelector('.stock-details .code').textContent;
                    if (ticker) {
                        fetchAndDrawStockHistory(ticker);
                    }
                }
            });
        }

        // --- Modal Logic ---
        const modal = document.getElementById('transaction-modal');
        const closeModalBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const assetSelect = document.getElementById('asset-select');
        const quantityInput = document.getElementById('quantity-input');
        const priceDisplay = document.getElementById('price-per-unit');
        const totalDisplay = document.querySelector('#total-amount-display span');
        const confirmBtn = document.getElementById('confirm-transaction-btn');
        const assetSelectLabel = document.getElementById('asset-select-label');
        const quantityInputLabel = document.getElementById('quantity-input-label');

        const getAssetDataFromCard = (cardId) => {
            const card = document.getElementById(cardId);
            if (!card) return [];
            return Array.from(card.querySelectorAll('.asset-item')).map(item => {
                const name = item.querySelector('span:first-child').textContent;
                const valueText = item.querySelector('span:last-child').textContent.replace('$', '').replace(',', '');
                return { name, value: parseFloat(valueText) };
            });
        };
        
        // Simulating bond and cash prices for the modal
        assetPriceMap.set('US Treasury', 100);
        assetPriceMap.set('Corp Bond A', 100);
        assetPriceMap.set('Muni Bond B', 100);
        assetPriceMap.set('Intl Bond C', 100);
        assetPriceMap.set('High-Yield D', 100);
        getAssetDataFromCard('cash-card').forEach(cash => assetPriceMap.set(cash.name, 1));

        const updateCalculation = () => {
            const selectedAssetName = assetSelect.value;
            const price = assetPriceMap.get(selectedAssetName) || 0;
            const quantity = parseFloat(quantityInput.value) || 0;
            const total = price * quantity;
            priceDisplay.textContent = `$${price.toFixed(2).toLocaleString()}`;
            totalDisplay.textContent = `$${total.toFixed(2).toLocaleString()}`;
        };

        const openModal = (action, assetType) => {
            modalTitle.textContent = `${action} ${assetType}`;
            assetSelect.innerHTML = '';
            let assetList = [];

            if (action === 'Sell' || action === 'Withdraw') {
                 const cardId = assetType === 'Stock' ? 'stock-assets-card' : `${assetType.toLowerCase()}-card`;
                 assetList = getAssetDataFromCard(cardId).map(a => a.name);
            } else { 
                if (assetType === 'Stock') assetList = latestStockTickers;
                // Even if card is gone, keep logic for modal if needed elsewhere
                if (assetType === 'Bond') assetList = ['US Treasury', 'Corp Bond A', 'Muni Bond B', 'Intl Bond C', 'High-Yield D'];
                if (assetType === 'Cash') assetList = getAssetDataFromCard('cash-card').map(c => c.name);
            }

            assetList.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                assetSelect.appendChild(option);
            });

            if (assetType === 'Cash') {
                assetSelectLabel.textContent = 'Account Name';
                quantityInputLabel.textContent = 'Amount';
                quantityInput.value = 100;
            } else {
                assetSelectLabel.textContent = 'Asset Name';
                quantityInputLabel.textContent = 'Quantity';
                quantityInput.value = 1;
            }
            updateCalculation();
            modal.classList.add('modal-visible');
        };

        const closeModal = () => modal.classList.remove('modal-visible');

        document.querySelectorAll('.card-action-button').forEach(button => {
            button.addEventListener('click', () => {
                const actionText = button.textContent;
                const card = button.closest('.card');
                let action, assetType;
                if (actionText.includes('Buy')) action = 'Buy';
                if (actionText.includes('Sell')) action = 'Sell';
                if (actionText.includes('Deposit')) action = 'Deposit';
                if (actionText.includes('Withdraw')) action = 'Withdraw';
                
                if (card.id.includes('stock')) assetType = 'Stock';
                // The 'bond-card' is removed, but we keep the logic in case it's triggered differently
                if (card.id.includes('bond')) assetType = 'Bond'; 
                if (card.id.includes('cash')) assetType = 'Cash';

                if(assetType) { // Ensure assetType is defined before opening
                    openModal(action, assetType);
                }
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        assetSelect.addEventListener('change', updateCalculation);
        quantityInput.addEventListener('input', updateCalculation);
        document.getElementById('quantity-up-arrow').addEventListener('click', () => { quantityInput.stepUp(); updateCalculation(); });
        document.getElementById('quantity-down-arrow').addEventListener('click', () => { quantityInput.stepDown(); updateCalculation(); });
        confirmBtn.addEventListener('click', () => {
            console.log('Transaction Confirmed:', { action: modalTitle.textContent, asset: assetSelect.value, quantity: quantityInput.value, total: totalDisplay.textContent });
            alert('Transaction details logged to console.');
            closeModal();
        });
    });
  </script>
</body>
</html>